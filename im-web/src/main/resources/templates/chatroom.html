<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>IM-WeChat即时通讯系统</title>
    <link rel="icon" href="../static/img/chat.ico" type="image/x-icon"/>
    <link rel="stylesheet" type="text/css" href="../static/css/chatroom.css">
    <link rel="stylesheet" type="text/css" href="../static/css/main.css">
    <link rel="stylesheet" type="text/css" href="../static/css/index.css">
    <link rel="stylesheet" type="text/css" href="../static/css/common/layui.css">
    <link rel="stylesheet" type="text/css" href="../static/css/common/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/common/fileinput.min.css">
</head>
<body background="../static/img/bg.jpg" style="background-repeat:no-repeat;background-size:cover; ">
<div id="app">
    <div role="alert" class="el-notification left" style="top: 16px; z-index: 2000;">
        <i class="el-notification__icon el-icon-success"></i>
        <div class="el-notification__group is-with-icon">
            <h2 class="el-notification__title">系统信息</h2>
            <div class="el-notification__content">
                <p>
                    在线用户： 1
                    <br>
                    开源地址：<a href="https://github.com/Left-Behind/im-wechat" target="_blank">im-wechat</a>
                    <br>
                    作者：<a href="https://www.tycoding.cn/" target="_blank">Azhu</a>
                    <br>
                    <button class="logout" onclick="logout()">注销</button>
                    <br>
                </p>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <div class="card">
            <header>
                <img class="avatar" width="40" height="40" alt="" src="">
                <p class="name">Azhu</p>
            </header>
            <footer>
                <input class="search" type="text" placeholder="search user...">
            </footer>
        </div>
        <div class="list">
            <ul >
                <li :class="{ active: current_window_id === 0 }" @click="selectWindow(0)">
                    <img class="avatar" width="30" height="30" alt="" src="../static/img/avatar/Group01.jpg">
                    <p class="name">官方群组</p>
                </li>
            </ul>
        </div>
    </div>
    <div class="main">
        <div class="message" ref="box">
            <!--<ul>
                <li v-for="item in messageList">
                    <p class="time">
                        <span>时间</span>
                    </p>
                    <div :class="'main ' +  (item.from.id == form.id ? 'self': '')">
                        <img class="avatar" width="30" height="30" :src="item.from.avatar"/>
                        <span class="main-name">{{item.from.name}}</span>
                        <div class="text">{{item.message}}</div>
                    </div>
                </li>
            </ul>-->
        </div>

        <div class="RightFoot">
            <div class="emjon">
                <ul>
                    <li><img src="../static/img/emoji/emoji_01.png"></li>
                    <li><img src="../static/img/emoji/emoji_02.png"></li>
                    <li><img src="../static/img/emoji/emoji_03.png"></li>
                    <li><img src="../static/img/emoji/emoji_04.png"></li>
                    <li><img src="../static/img/emoji/emoji_05.png"></li>
                    <li><img src="../static/img/emoji/emoji_06.png"></li>
                    <li><img src="../static/img/emoji/emoji_07.png"></li>
                    <li><img src="../static/img/emoji/emoji_08.png"></li>
                    <li><img src="../static/img/emoji/emoji_09.png"></li>
                    <li><img src="../static/img/emoji/emoji_10.png"></li>
                    <li><img src="../static/img/emoji/emoji_11.png"></li>
                    <li><img src="../static/img/emoji/emoji_12.png"></li>
                    <li><img src="../static/img/emoji/emoji_13.png"></li>
                    <li><img src="../static/img/emoji/emoji_14.png"></li>
                    <li><img src="../static/img/emoji/emoji_15.png"></li>
                    <li><img src="../static/img/emoji/emoji_16.png"></li>
                    <li><img src="../static/img/emoji/emoji_17.png"></li>
                    <li><img src="../static/img/emoji/emoji_18.png"></li>
                    <li><img src="../static/img/emoji/emoji_19.png"></li>
                    <li><img src="../static/img/emoji/emoji_20.png"></li>
                    <li><img src="../static/img/emoji/emoji_21.png"></li>
                    <li><img src="../static/img/emoji/emoji_22.png"></li>
                    <li><img src="../static/img/emoji/emoji_23.png"></li>
                    <li><img src="../static/img/emoji/emoji_24.png"></li>
                </ul>
            </div>
            <div class="footTop">
                <ul>
                    <li class="ExP">
                        <img src="../static/img/emoji.jpg">
                    </li>
                    <li class="file-upload">
                        <a data-toggle="modal" data-target="#upload-modal" data-backdrop="static">
                            <img src="../static/img/upload.jpg">
                        </a>
                    </li>
                </ul>
            </div>
            <div class="inputBox">
                <textarea id="dope" style="width: 99%;height: 75px; border: none;outline: none;" name="" rows=""
                          cols=""></textarea>
                <button title="按下回车可发送" class="sendBtn">发送</button>
                <div class="btn">
                    <button  size="mini" type="danger" >清空</button>
                    <button title="按下回车可发送" size="mini" icon="el-icon-position" type="success">发送</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" src="../static/js/common/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../static/js/common/jquery.actual.min.js"></script>
<script type="text/javascript" src="../static/js/common/bootstrap.min.js"></script>
<script type="text/javascript" src="../static/js/common/fileinput.min.js"></script>
<script type="text/javascript" src="../static/js/common/zh.js"></script>
<script type="text/javascript" src="../static/js/chatroom.js"></script>
<script type="text/javascript">
    var userId;
    var userInfo
    var socket;
    var sentMessageMap;
    var sentMessageMap_Group;
    var token;
    token = getCookie("token");
    console.log(token);
    //setUserInfo();
    if (!window.WebSocket) {
        window.WebSocket = window.MozWebSocket;
    }
    if (window.WebSocket) {
        socket = new WebSocket("ws://www.azhu.work:8888/ws");
        socket.onmessage = function (event) {
            var json = JSON.parse(event.data);
            if (json.status == 200) {
                var type = json.data.type;
                console.log("收到一条新信息，类型为：" + type);
                switch (type) {
                    case "LOGIN":
                        ws.loginReceive();
                        break;
                    case "SINGLE_SENDING":
                        ws.singleReceive(json.data);
                        break;
                    case "GROUP_SENDING":
                        ws.groupReceive(json.data);
                        break;
                    case "FILE_MSG_SINGLE_SENDING":
                        ws.fileMsgSingleRecieve(json.data);
                        break;
                    case "FILE_MSG_GROUP_SENDING":
                        ws.fileMsgGroupRecieve(json.data);
                        break;
                    default:
                        console.log("不正确的类型！");
                }
            } else {
                alert(json.msg);
                console.log(json.msg);
            }
        };

        // 连接成功1秒后，将用户信息注册到服务器在线用户表 这里是直接发送给WebSocketServerHandler.handlerWebSocketFrame直接处理登入
        socket.onopen = setTimeout(function (event) {
            ws.login();
            console.log("WebSocket已成功连接！");
        }, 1000)

        socket.onclose = function (event) {
            console.log("WebSocket已关闭...");
        };
    } else {
        alert("您的浏览器不支持WebSocket！");
    }

    function find() {
        $.ajax({
            type: 'POST',
            url: 'chatroom/add_friend',
            dataType: 'json',
            data: {
                findName: $("#findName").val()
            },
            success: function (data) {
                if (data.status == 200) {
                    alert(data.msg);
                    window.location.reload();//刷新界面
                } else {
                    alert(data.msg);
                }
            }
        });
    }

    function getCookie(cookie_name) {
        var allcookies = document.cookie;
        //索引长度，开始索引的位置
        var cookie_pos = allcookies.indexOf(cookie_name);

        // 如果找到了索引，就代表cookie存在,否则不存在
        if (cookie_pos != -1) {
            // 把cookie_pos放在值的开始，只要给值加1即可
            //计算取cookie值得开始索引，加的1为“=”
            cookie_pos = cookie_pos + cookie_name.length + 1;
            //计算取cookie值得结束索引
            var cookie_end = allcookies.indexOf(";", cookie_pos);

            if (cookie_end == -1) {
                cookie_end = allcookies.length;

            }
            //得到想要的cookie的值
            var value = unescape(allcookies.substring(cookie_pos, cookie_end));
        }
        return value;
    }

</script>

</body>
</html>
